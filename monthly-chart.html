<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Chart Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 via-white to-gray-100 min-h-screen p-6">

  <!-- Header -->
  <header class="mb-8 max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">üìä Monthly Chart</h1>
    <button id="backHomeBtn" class="btn flex items-center gap-1">üè† Back Home</button>
  </header>

  <!-- Search -->
  <section class="max-w-6xl mx-auto mb-6">
    <input
      id="searchInput"
      type="text"
      placeholder="Search students by Admission No, Name or Class"
      class="w-full border border-gray-300 rounded-2xl px-4 py-3 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"
    />
  </section>

  <!-- Students Grid -->
  <section class="max-w-6xl mx-auto">
    <div id="studentsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </section>

  <!-- Monthly Chart Modal -->
  <div id="monthlyChartModal" class="fixed inset-0 bg-black/50 flex justify-center items-start p-6 overflow-auto hidden z-50">
    <div class="bg-white rounded-2xl max-w-full w-full sm:max-w-4xl p-6 relative max-h-[90vh] overflow-auto shadow-2xl">

      <button id="closeModalBtn" class="absolute top-4 right-4 text-3xl font-bold hover:text-red-600 cursor-pointer" aria-label="Close modal">&times;</button>
      
      <h2 id="modalStudentName" class="text-2xl font-bold mb-6 truncate text-gray-800"></h2>

      <!-- Year & Month Selectors -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <div class="flex-1">
          <label for="yearSelect" class="block font-medium mb-1">Year</label>
          <select id="yearSelect" class="input-field w-full"></select>
        </div>
        <div class="flex-1">
          <label for="monthSelect" class="block font-medium mb-1">Month</label>
          <select id="monthSelect" class="input-field w-full"></select>
        </div>
      </div>

      <!-- Improvements Cards -->
      <div id="improvementsSection" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>

      <!-- Leave Dates Picker -->
      <div class="mb-4">
        <label class="block font-semibold text-blue-700 mb-1">Select Leave Dates</label>
        <div id="leaveDatesContainer" class="grid grid-cols-7 gap-1"></div>
      </div>

      <button id="saveImprovementsBtn" class="btn w-full sm:w-auto">üíæ Save Improvements</button>

      <!-- History Cards -->
      <h3 class="mt-8 font-bold text-gray-800 mb-4">History</h3>
      <div id="historyCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBv1446L82JoCaHa_sbsfDh9fb3fVGM2h8",
    authDomain: "hifz-monthly-report.firebaseapp.com",
    databaseURL: "https://hifz-monthly-report-default-rtdb.firebaseio.com",
    projectId: "hifz-monthly-report",
    storageBucket: "hifz-monthly-report.firebasestorage.app",
    messagingSenderId: "303055298705",
    appId: "1:303055298705:web:7098446d7622e580559f30"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const studentsRef = ref(db, "students");
  const studentsContainer = document.getElementById("studentsContainer");
  const searchInput = document.getElementById("searchInput");
  const monthlyChartModal = document.getElementById("monthlyChartModal");
  const modalStudentName = document.getElementById("modalStudentName");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const improvementsSection = document.getElementById("improvementsSection");
  const saveImprovementsBtn = document.getElementById("saveImprovementsBtn");
  const historyCards = document.getElementById("historyCards");
  const backHomeBtn = document.getElementById("backHomeBtn");
  const leaveDatesContainer = document.getElementById("leaveDatesContainer");

  let studentsList = [];
  let currentStudent = null;
  let selectedLeaveDates = [];

  const START_YEAR = 2025;
  const today = new Date();
  const CURRENT_YEAR = today.getFullYear();
  const CURRENT_MONTH = today.getMonth();
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  const labelMap = {
    "1": "‡¥™‡¥æ‡¥†‡¥Ç",
    "2": "5 ‡¥™‡¥æ‡¥†‡¥Ç",
    "3": "‡¥Æ‡µÅ‡¥±‡¥æ‡¥ú‡¥Ö",
    "H1": "1 ‡¥Æ‡µÅ‡¥±‡¥æ‡¥ú‡¥Ö",
    "H2": "2 ‡¥Æ‡µÅ‡¥±‡¥æ‡¥ú‡¥Ö",
    "H3": "3 ‡¥Æ‡µÅ‡¥±‡¥æ‡¥ú‡¥Ö"
  };

  // Fetch Students
  onValue(studentsRef, snapshot => {
    const data = snapshot.val();
    studentsList = data ? Object.values(data) : [];
    renderStudentsList(studentsList);
  });

  function renderStudentsList(students) {
    studentsContainer.innerHTML = "";
    students.forEach(student => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl shadow-md hover:shadow-xl transition p-6 flex flex-col justify-between border border-gray-200 cursor-pointer";
      card.innerHTML = `
        <div>
          <h3 class="font-semibold text-lg truncate">üë§ ${student.name}</h3>
          <p class="text-sm truncate">Admission No: ${student.admissionNumber}</p>
          <p class="text-sm truncate">Class: ${student.class}</p>
        </div>
        <span class="mt-2 inline-block px-2 py-1 text-xs font-semibold rounded-full ${student.hafizStatus==='Hafiz'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">
          ${student.hafizStatus}
        </span>
      `;
      card.addEventListener("click", () => openMonthlyChartModal(student));
      studentsContainer.appendChild(card);
    });
  }

  searchInput.addEventListener("input", () => {
    const keyword = searchInput.value.toLowerCase();
    const filtered = studentsList.filter(s =>
      s.name.toLowerCase().includes(keyword) ||
      s.admissionNumber.toLowerCase().includes(keyword) ||
      s.class.toLowerCase().includes(keyword)
    );
    renderStudentsList(filtered);
  });

  function populateYearSelect() {
    yearSelect.innerHTML = "";
    for(let y=START_YEAR; y<=CURRENT_YEAR; y++){
      const option = document.createElement("option");
      option.value = y;
      option.textContent = y;
      yearSelect.appendChild(option);
    }
    yearSelect.value = CURRENT_YEAR;
  }

  function populateMonthSelect() {
    monthSelect.innerHTML = "";
    monthNames.forEach((m,i)=>{
      const option = document.createElement("option");
      option.value = i;
      option.textContent = m;
      monthSelect.appendChild(option);
    });
    monthSelect.value = today.getMonth();
  }

  function renderImprovementInputs(hafizStatus) {
    improvementsSection.innerHTML = "";
    const labels = hafizStatus === "Hafiz" ? ["H1", "H2", "H3"] : ["1", "2", "3"];
    const cardBg = hafizStatus === "Hafiz" ? "bg-green-50 border-green-300" : "bg-yellow-50 border-yellow-300";
    const cardLabelColor = hafizStatus === "Hafiz" ? "text-green-700" : "text-yellow-700";

    labels.forEach(key => {
      const div = document.createElement("div");
      div.className = `rounded-2xl shadow-md p-4 border ${cardBg} hover:shadow-lg transition flex flex-col gap-2`;
      div.innerHTML = `
        <label class="font-semibold ${cardLabelColor}">${labelMap[key]}</label>
        <input type="text" id="improve${key}" placeholder="Enter ${labelMap[key]}" class="input-field" />
      `;
      improvementsSection.appendChild(div);
    });

    // Extra fields: TotalClasses, Leaves, Attendance
    ["TotalClasses","Leaves","Attendance"].forEach(key=>{
      const div = document.createElement("div");
      const bg = key==="Leaves"?"bg-blue-50 border-blue-300":"bg-gray-50 border-gray-300";
      div.className = `rounded-2xl shadow-md p-4 border ${bg} hover:shadow-lg transition flex flex-col gap-2`;
      div.innerHTML = `
        <label class="font-semibold ${key==="Leaves"?"text-blue-700":"text-gray-700"}">${key==="TotalClasses"?"Total Classes":key}</label>
        <input type="${key==="Leaves"?"number":"text"}" id="improve${key}" placeholder="Enter ${key}" class="input-field" />
      `;
      improvementsSection.appendChild(div);
    });

    // Auto-calculate attendance when TotalClasses or Leaves change
    const totalInput = document.getElementById("improveTotalClasses");
    const leavesInput = document.getElementById("improveLeaves");
    const attendanceInput = document.getElementById("improveAttendance");

    function updateAttendance(){
      const total = parseInt(totalInput.value) || 0;
      const leaves = parseInt(leavesInput.value) || 0;
      attendanceInput.value = total - leaves;
    }

    totalInput.addEventListener("input", updateAttendance);
    leavesInput.addEventListener("input", updateAttendance);
  }

  function generateLeaveDatesCalendar(year, month, selectedDates=[]) {
    leaveDatesContainer.innerHTML = "";
    selectedLeaveDates = [...selectedDates];

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month+1, 0);
    const totalDays = lastDay.getDate();

    for(let d=1; d<=totalDays; d++){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = d;
      btn.className = `border rounded p-1 text-sm hover:bg-blue-100 transition ${
        selectedLeaveDates.includes(d) ? "bg-blue-500 text-white" : "bg-white text-gray-800"
      }`;
      btn.addEventListener("click", ()=>{
        if(selectedLeaveDates.includes(d)){
          selectedLeaveDates = selectedLeaveDates.filter(x=>x!==d);
        }else{
          selectedLeaveDates.push(d);
        }
        generateLeaveDatesCalendar(year, month, selectedLeaveDates);
      });
      leaveDatesContainer.appendChild(btn);
    }
  }

  function openMonthlyChartModal(student){
    currentStudent = student;
    modalStudentName.textContent = `${student.name} (${student.admissionNumber})`;
    populateYearSelect();
    populateMonthSelect();
    renderImprovementInputs(student.hafizStatus);
    monthlyChartModal.classList.remove("hidden");
    selectedLeaveDates = [];
    generateLeaveDatesCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
    loadImprovementHistory(student.admissionNumber);
    loadImprovementsForSelected();
  }

  closeModalBtn.addEventListener("click", ()=>{ monthlyChartModal.classList.add("hidden"); clearForm(); });
  backHomeBtn.addEventListener("click", ()=> window.location.href = "index.html");

  yearSelect.addEventListener("change", ()=>{
    clearImprovementInputs();
    selectedLeaveDates=[];
    generateLeaveDatesCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
    loadImprovementsForSelected();
  });

  monthSelect.addEventListener("change", ()=>{
    clearImprovementInputs();
    selectedLeaveDates=[];
    generateLeaveDatesCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
    loadImprovementsForSelected();
  });

  function loadImprovementsForSelected(){
    if(!currentStudent) return;
    const path = `improvements/${currentStudent.admissionNumber}/${yearSelect.value}/${monthSelect.value}`;
    onValue(ref(db,path), snapshot=>{
      const data = snapshot.val();
      if(data){
        fillImprovementInputs(data,currentStudent.hafizStatus);
        selectedLeaveDates = data.leaveDates || [];
        generateLeaveDatesCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value), selectedLeaveDates);
      } else {
        clearImprovementInputs();
        selectedLeaveDates = [];
        generateLeaveDatesCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
      }
    }, {onlyOnce:true});
  }

  function fillImprovementInputs(data,hafizStatus){
    const labels = hafizStatus==="Hafiz"?["H1","H2","H3"]:["1","2","3"];
    labels.forEach(key=>{
      const input = document.getElementById(`improve${key}`);
      input.value = data[key] || "";
    });
    document.getElementById("improveTotalClasses").value = data.totalClasses || "";
    document.getElementById("improveLeaves").value = data.leaves || "";
    document.getElementById("improveAttendance").value = data.attendance || "";
  }

  function clearImprovementInputs(){
    improvementsSection.querySelectorAll("input").forEach(i=>i.value="");
  }

  function clearForm(){
    clearImprovementInputs();
    historyCards.innerHTML = "";
    currentStudent=null;
    yearSelect.value = CURRENT_YEAR;
    monthSelect.value = CURRENT_MONTH;
    selectedLeaveDates = [];
    leaveDatesContainer.innerHTML="";
  }

  function loadImprovementHistory(admNo){
    onValue(ref(db, `improvements/${admNo}`), snapshot=>{
      const data = snapshot.val();
      historyCards.innerHTML = "";
      if(!data){ historyCards.innerHTML = `<div class="text-gray-400 italic text-center py-8">No improvements recorded yet.</div>`; return; }

      Object.entries(data).sort((a,b)=>b[0]-a[0]).forEach(([year, months])=>{
        Object.entries(months).sort((a,b)=>b[0]-a[0]).forEach(([month, improvements])=>{
          const status = improvements.status || "Not-Hafiz";
          const card = document.createElement("div");
          card.className = "bg-white rounded-2xl p-4 shadow-md hover:shadow-lg border border-gray-200 transition";

          let ul = "<ul class='list-disc pl-5 text-gray-700'>";
          Object.keys(improvements).forEach(k=>{
            if(k!=="status" && k!=="leaveDates" && improvements[k]){ if(labelMap[k]) ul += `<li>${labelMap[k]}: ${improvements[k]}</li>`; }
          });
          if(improvements.totalClasses) ul += `<li>Total Classes: ${improvements.totalClasses}</li>`;
          if(improvements.leaves) ul += `<li>Leaves: ${improvements.leaves}</li>`;
          if(improvements.attendance) ul += `<li>Attendance: ${improvements.attendance}</li>`;
          if(improvements.leaveDates && improvements.leaveDates.length>0) ul += `<li>Leave Dates: ${improvements.leaveDates.join(", ")}</li>`;
          ul += "</ul>";

          card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold text-gray-800">${monthNames[month]} ${year}</span>
              <span class="text-xs font-medium ${status==='Hafiz'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded-full">${status}</span>
            </div>
            ${ul}
          `;
          historyCards.appendChild(card);
        });
      });
    }, {onlyOnce:true});
  }

  saveImprovementsBtn.addEventListener("click", ()=>{
    if(!currentStudent) return alert("Select a student first.");
    const labels = currentStudent.hafizStatus==="Hafiz"?["H1","H2","H3"]:["1","2","3"];
    let improvementsData = { status: currentStudent.hafizStatus };
    let allEmpty=true;
    labels.forEach(key=>{
      const val=document.getElementById(`improve${key}`).value.trim();
      improvementsData[key]=val;
      if(val) allEmpty=false;
    });

    // Extra fields
    improvementsData.totalClasses = document.getElementById("improveTotalClasses").value.trim();
    improvementsData.leaves = document.getElementById("improveLeaves").value.trim();
    improvementsData.attendance = document.getElementById("improveAttendance").value.trim();
    improvementsData.leaveDates = [...selectedLeaveDates].sort((a,b)=>a-b);

    if(allEmpty && !improvementsData.totalClasses && !improvementsData.leaves && !improvementsData.attendance && improvementsData.leaveDates.length===0){
      return alert("Enter at least one field.");
    }

    set(ref(db, `improvements/${currentStudent.admissionNumber}/${yearSelect.value}/${monthSelect.value}`), improvementsData)
      .then(()=>{ alert("Improvements saved."); loadImprovementHistory(currentStudent.admissionNumber); })
      .catch(err=>alert("Error: "+err.message));
  });

</script>

<style>
  .input-field { width: 100%; padding: 12px 14px; border-radius: 0.75rem; border: 1px solid #d1d5db; outline: none; font-size: 1rem; transition: all 0.2s; }
  .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgb(37 99 235 / 0.3); }
  .btn { padding: 0.75rem 1.25rem; background-color: #2563eb; color: white; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
  .btn:hover { background-color: #1e40af; }
</style>

</body>
</html>
